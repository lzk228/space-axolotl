using Content.Client.Message;
using Content.Client.UserInterface.Controls;
using Content.Shared.GatewayStation;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using Robust.Shared.Utility;
using Content.Client.Pinpointer.UI;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.GatewayStation;

[GenerateTypedNameReferences]
public sealed partial class StationGatewayWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entManager = default!;
    private readonly SpriteSystem _spriteSystem;
    private readonly SharedTransformSystem _xformSystem;

    public event Action<NetEntity?>? SendGatewayLinkChangeAction;

    private NetEntity? _trackedEntity;
    private Texture? _ringTexture;
    private Texture? _ringFilledTexture;

    public StationGatewayWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _spriteSystem = _entManager.System<SpriteSystem>();
        _xformSystem = _entManager.System<SharedTransformSystem>();

        NavMap.TrackedEntitySelectedAction += ClickGatewayOnNavMap;
    }

    public void Set(StationGatewayBoundUserInterface userInterface, string stationName, EntityUid? mapUid)
    {
        _ringTexture = _spriteSystem.Frame0(new SpriteSpecifier.Texture(new ResPath("/Textures/Interface/NavMap/ring.png")));
        _ringFilledTexture = _spriteSystem.Frame0(new SpriteSpecifier.Texture(new ResPath("/Textures/Interface/NavMap/ring_filled.png")));

        if (_entManager.TryGetComponent<TransformComponent>(mapUid, out var xform))
            NavMap.MapUid = xform.GridUid;
        else
            NavMap.Visible = false;

        StationName.AddStyleClass("LabelBig");
        StationName.Text = stationName;
        NavMap.ForceNavMapUpdate();

        SendGatewayLinkChangeAction += userInterface.SendGatewayLinkChangeMessage;
    }

    public void ShowGateways(StationGatewayState state, EntityUid monitor, EntityCoordinates? monitorCoords)
    {
        ClearOutDatedData();

        var gateways = state.Gateways;

        //No gateways
        if (gateways.Count == 0)
        {
            NoGatewayLabel.Visible = true;
            return;
        }

        NoGatewayLabel.Visible = false;


        // Show all gateways
        foreach (var gate in gateways)
        {
            var coordinates = _entManager.GetCoordinates(gate.Coordinates);

            var selected = gate.GatewayUid == state.SelectedGateway;
            var linked = gate.LinkCoordinates is not null;

            var bgColor = linked ? new Color(18, 61, 82) : new Color(30, 30, 34);
            if (selected)
                bgColor = new Color(49, 117, 7);


            // Primary container to hold the button UI elements
            var panelContainer = new PanelContainer()
            {
                HorizontalAlignment = HAlignment.Center,
                VerticalAlignment = VAlignment.Center,
                HorizontalExpand = true,
                Margin = new Thickness(10),
                PanelOverride = new StyleBoxFlat
                {
                    BackgroundColor = bgColor,
                    BorderColor = Color.Black,
                    BorderThickness = new(2),
                },
            };

            GatewaysTable.AddChild(panelContainer);

            var mainBox = new BoxContainer()
            {
                Orientation = LayoutOrientation.Vertical,
                HorizontalExpand = true,
            };

            panelContainer.AddChild(mainBox);


            // Gate name
            var nameLabel = new RichTextLabel()
            {
                HorizontalExpand = true,
                HorizontalAlignment = HAlignment.Center,
                Margin = new Thickness(0, 5),
            };
            nameLabel.SetMarkup($"[bold]{gate.Name}[/bold]");

            mainBox.AddChild(nameLabel);


            //Left subpart
            var leftBox = new BoxContainer()
            {
                SetWidth = 30,
                Orientation = LayoutOrientation.Vertical,
                HorizontalExpand = true,
            };

            mainBox.AddChild(leftBox);


            //Right subpart
            var rightBox = new BoxContainer()
            {
                Orientation = LayoutOrientation.Vertical,
                HorizontalExpand = true,
            };

            mainBox.AddChild(rightBox);


            // Locating button
            var locateButton = new GatewayButton()
            {
                Text = Loc.GetString("gateway-console-user-interface-locate"),
                GatewayUid = gate.GatewayUid,
                Coordinates = coordinates,
                HorizontalAlignment = HAlignment.Right,
                SetWidth = 200f,
            };

            rightBox.AddChild(locateButton);


            // Link\Unlink button
            var buttonLoc = "gateway-console-user-interface-start-connection";
            if (linked)
                buttonLoc = "gateway-console-user-interface-cut-connection";
            if (!gate.Powered)
                buttonLoc = "gateway-console-user-interface-no-power";

            var linkButton = new GatewayButton()
            {
                Text = Loc.GetString(buttonLoc),
                GatewayUid = gate.GatewayUid,
                Coordinates = coordinates,
                HorizontalAlignment = HAlignment.Right,
                SetWidth = 200f,
                Disabled = !gate.Powered,
            };
            linkButton.OnButtonUp += _ =>
            {
                SendGatewayLinkChangeAction?.Invoke(gate.GatewayUid);
            };

            rightBox.AddChild(linkButton);


            //Add gateway coordinates to the NavMap
            var blipColor = Color.Aqua;
            if (!gate.Powered)
                blipColor = Color.Gray;
            if (selected)
                blipColor = Color.Green;

            if (coordinates != null && NavMap.Visible && _ringTexture is not null && _ringFilledTexture is not null)
            {
                var blip = new NavMapBlip(
                    coordinates.Value,
                    linked ? _ringFilledTexture : _ringTexture,
                    blipColor,
                    false);
                NavMap.TrackedEntities.TryAdd(gate.GatewayUid, blip);

                locateButton.OnButtonUp += _ =>
                {
                    if (_trackedEntity == gate.GatewayUid)
                        _trackedEntity = null;
                    else
                    {
                        _trackedEntity = gate.GatewayUid;
                        NavMap.CenterToCoordinates(coordinates.Value);
                    }

                    UpdateGatewaysTable();
                };
            }

            //Add gateways links lines
            if (gate.Coordinates is not null && gate.LinkCoordinates is not null)
            {
                var coordsOne = _entManager.GetCoordinates(gate.Coordinates);
                var coordTwo = _entManager.GetCoordinates(gate.LinkCoordinates);

                if (coordsOne is null || coordTwo is null)
                    return;

                var mapId1 = _xformSystem.GetMapId(coordsOne.Value);
                var mapId2 = _xformSystem.GetMapId(coordTwo.Value);

                if (mapId1 != mapId2)
                    return;

                if (mapId1 == MapId.Nullspace || mapId2 == MapId.Nullspace)
                    return;

                NavMap.LinkLines.Add(
                    new GatewayLinkLine(
                        _xformSystem.ToMapCoordinates(coordsOne.Value).Position,
                        _xformSystem.ToMapCoordinates(coordTwo.Value).Position));
            }
        }
    }

    private void ClickGatewayOnNavMap(NetEntity? netEntity)
    {
        SendGatewayLinkChangeAction?.Invoke(netEntity);
    }

    private void ClearOutDatedData()
    {
        GatewaysTable.RemoveAllChildren();
        NavMap.TrackedCoordinates.Clear();
        NavMap.TrackedEntities.Clear();
        NavMap.LinkLines.Clear();
    }

    private void UpdateGatewaysTable()
    {
        foreach (var gate in GatewaysTable.Children)
        {
            if (gate is not GatewayButton)
                continue;

            var castGate = (GatewayButton)gate;

            if (castGate?.Coordinates == null)
                continue;

            if (NavMap.TrackedEntities.TryGetValue(castGate.GatewayUid, out var data))
            {
                data = new NavMapBlip(
                    data.Coordinates,
                    data.Texture,
                    Color.Aqua,
                    false);

                NavMap.TrackedEntities[castGate.GatewayUid] = data;
            }
        }
    }
}
public sealed class GatewayButton : Button
{
    public int IndexInTable;
    public NetEntity GatewayUid;
    public EntityCoordinates? Coordinates;
}
